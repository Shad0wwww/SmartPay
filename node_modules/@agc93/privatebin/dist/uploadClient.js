"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.PrivateBinClient = void 0;
const encryption_1 = require("./encryption");
const pako_1 = __importDefault(require("pako"));
const axios_1 = __importDefault(require("axios"));
const bs58_1 = require("bs58");
/**
 * A simple client class to encapsulate uploading pastes to a PrivateBin server
 */
class PrivateBinClient {
    /**
     *  Creates a new PrivateBin client for the given server URL
     *
     * @param baseUrl: The base URL of the server. This should be the root address like `https://privatebin.net`
     */
    constructor(baseUrl) {
        this.getMessageBytes = (data, compression) => {
            const buffer = Buffer.from(JSON.stringify({ paste: data }), 'utf8');
            if (compression === 'zlib') {
                return Buffer.from(pako_1.default.deflateRaw(new Uint8Array(buffer)));
            }
            else {
                return buffer;
            }
        };
        /**
         * Uploads given content as a paste to the PrivateBin server.
         *
         * @param content The paste contents to upload
         * @param options The upload options to use
         * @param encryptOpts Additional encryption options for your paste
         */
        this.uploadContent = async (content, options, encryptOpts) => {
            var opts = { ...this.getDefaultOptions(), ...options };
            var encryptionOpts = encryptOpts !== null && encryptOpts !== void 0 ? encryptOpts : new encryption_1.EncryptionBuilder().enableCompression(true).buildOptions();
            var messageBuffer = this.getMessageBytes(content, encryptionOpts.compression);
            var encryptedData = await encryption_1.encryptMessageBuffer(messageBuffer, encryptionOpts, opts);
            var resp = await this.postPasteContent(encryptedData.data, encryptedData.cipherText, opts);
            if (resp.status == 201 || resp.status == 200) {
                return {
                    response: resp.data,
                    success: resp.data.status == 0,
                    urlKey: bs58_1.encode(encryptionOpts.key),
                    url: `${this._baseUrl}${resp.data.url}`
                };
            }
            throw new Error("Upload failed!");
        };
        this.postPasteContent = async (requestData, cipherText, options) => {
            var requestBody = {
                v: 2,
                ct: cipherText.toString('base64'),
                adata: requestData,
                meta: {
                    expire: options.expiry
                }
            };
            var resp = await axios_1.default.post("/", requestBody, this.getRequestConfig());
            return resp;
        };
        this.getRequestConfig = () => {
            return {
                baseURL: this._baseUrl,
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'JSONHttpRequest' // required by privatebin. yikes that casing.
                }
            };
        };
        baseUrl = baseUrl.startsWith('https://') ? baseUrl : `https://${baseUrl}`;
        this._baseUrl = baseUrl.replace(/\/+$/, ""); // remove any trailing slashes
    }
    getDefaultOptions() {
        return {
            expiry: '1week',
            openDiscussion: false,
            burnAfterReading: false,
            uploadFormat: 'markdown'
        };
    }
}
exports.PrivateBinClient = PrivateBinClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkQ2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3VwbG9hZENsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFDQSw2Q0FBMkY7QUFDM0YsZ0RBQXdCO0FBQ3hCLGtEQUFrRDtBQUNsRCwrQkFBOEI7QUFFOUI7O0dBRUc7QUFDSCxNQUFhLGdCQUFnQjtJQW9CekI7Ozs7T0FJRztJQUNILFlBQVksT0FBZTtRQWZuQixvQkFBZSxHQUFHLENBQUMsSUFBWSxFQUFFLFdBQXdCLEVBQVUsRUFBRTtZQUN6RSxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUNwRSxJQUFJLFdBQVcsS0FBSyxNQUFNLEVBQUU7Z0JBQ3hCLE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFJLENBQUMsVUFBVSxDQUFDLElBQUksVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUMvRDtpQkFBTTtnQkFDSCxPQUFPLE1BQU0sQ0FBQzthQUNqQjtRQUNMLENBQUMsQ0FBQTtRQWFEOzs7Ozs7V0FNRztRQUNILGtCQUFhLEdBQUcsS0FBSyxFQUFFLE9BQWUsRUFBRSxPQUF1QixFQUFFLFdBQWdDLEVBQTBCLEVBQUU7WUFDekgsSUFBSSxJQUFJLEdBQW1CLEVBQUMsR0FBRyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxHQUFHLE9BQU8sRUFBQyxDQUFDO1lBQ3JFLElBQUksY0FBYyxHQUFHLFdBQVcsYUFBWCxXQUFXLGNBQVgsV0FBVyxHQUFJLElBQUksOEJBQWlCLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUNuRyxJQUFJLGFBQWEsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sRUFBRSxjQUFjLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDOUUsSUFBSSxhQUFhLEdBQUcsTUFBTSxpQ0FBb0IsQ0FBQyxhQUFhLEVBQUUsY0FBYyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ3BGLElBQUksSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsYUFBYSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUMzRixJQUFJLElBQUksQ0FBQyxNQUFNLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxNQUFNLElBQUksR0FBRyxFQUFFO2dCQUMxQyxPQUFPO29CQUNILFFBQVEsRUFBRSxJQUFJLENBQUMsSUFBSTtvQkFDbkIsT0FBTyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUM7b0JBQzlCLE1BQU0sRUFBRSxhQUFNLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQztvQkFDbEMsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtpQkFDMUMsQ0FBQTthQUNKO1lBQ0QsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ3RDLENBQUMsQ0FBQTtRQUVPLHFCQUFnQixHQUFHLEtBQUssRUFBRSxXQUFrQixFQUFFLFVBQWtCLEVBQUUsT0FBdUIsRUFBRSxFQUFFO1lBQ2pHLElBQUksV0FBVyxHQUFHO2dCQUNkLENBQUMsRUFBRSxDQUFDO2dCQUNKLEVBQUUsRUFBRSxVQUFVLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQztnQkFDakMsS0FBSyxFQUFFLFdBQVc7Z0JBQ2xCLElBQUksRUFBRTtvQkFDRixNQUFNLEVBQUUsT0FBTyxDQUFDLE1BQU07aUJBQ3pCO2FBQ0osQ0FBQztZQUNGLElBQUksSUFBSSxHQUFHLE1BQU0sZUFBSyxDQUFDLElBQUksQ0FBa0IsR0FBRyxFQUFFLFdBQVcsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFBO1lBQ3ZGLE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUMsQ0FBQTtRQUVPLHFCQUFnQixHQUFHLEdBQXVCLEVBQUU7WUFDaEQsT0FBTztnQkFDSCxPQUFPLEVBQUUsSUFBSSxDQUFDLFFBQVE7Z0JBQ3RCLE9BQU8sRUFBRTtvQkFDTCxjQUFjLEVBQUUsa0JBQWtCO29CQUNsQyxrQkFBa0IsRUFBRSxpQkFBaUIsQ0FBQyw2Q0FBNkM7aUJBQ3RGO2FBQ0osQ0FBQTtRQUNMLENBQUMsQ0FBQTtRQWpERyxPQUFPLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxXQUFXLE9BQU8sRUFBRSxDQUFDO1FBQzFFLElBQUksQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyw4QkFBOEI7SUFDL0UsQ0FBQztJQTNCTyxpQkFBaUI7UUFDckIsT0FBTztZQUNILE1BQU0sRUFBRSxPQUFPO1lBQ2YsY0FBYyxFQUFFLEtBQUs7WUFDckIsZ0JBQWdCLEVBQUUsS0FBSztZQUN2QixZQUFZLEVBQUUsVUFBVTtTQUMzQixDQUFDO0lBQ04sQ0FBQztDQXNFSjtBQTlFRCw0Q0E4RUMifQ==